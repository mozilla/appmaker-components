<element name="app-piechart">
  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-piechart.css">
    <div class="sheen"></div>
    <canvas id="canvas" width="200" height="200" />
  </template>
  <description>
    Listens for a message and counts
  </description>
  <thumbnail>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpBMkYwNDQzMzE4MDYxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpBMkYwNDQzNDE4MDYxMUUzQkQ3OEUxRDEyODNBNUUxMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkEyRjA0NDMxMTgwNjExRTNCRDc4RTFEMTI4M0E1RTExIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkEyRjA0NDMyMTgwNjExRTNCRDc4RTFEMTI4M0E1RTExIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+eH4R/gAABU5JREFUeNrEV1tsFFUYPufMzN662223F4XWtrJQCsVCEQ23EDFWCI2JPGCIJhLjm4mYJqahiEqEqOHBEBIjD0IaQ/HFaFJM1KiFBxVC0oItxYJc2tSWtst22253d2Zn5hz/M724HXdmh6rxJH/OZc6c//+//3YOZowhJ20yoQW8bvKcSPBTMF2HMa7CGOXD7xjOiKs6G4T1K7D2g0sk7TCednQwF8COJqbVlYmUdkbXaYo5bJSyBOw/BcPluc7HNgh4VI0eFQWyH7SS+LZrA3F68XoM9fRPoaH7MoqnNAz7cMArorJiD1pTGWCba0MUegFj44w00HGgd4HkbEysBAjD8pdwSB3//G3nGG37cYgMRWVHqJYVedjLDeVKQ32JG87golwF2gN0y4kA62HpG/ixNDKZTr/z2Q2xb3CaoEW0VRX+5LFXV8l+rxiC6SjQLqAuOwHAZugiMC/uHYin3mrtc4PzZTKf24ydClHgl/441bR2KhSQVsM0ArQ5E4lMAbwwvMRhv3J7Umn+9DeXpjMzI5aDebbvTBLJzTPN9XJpgWstzLuBNgKl+Md57YDZEc58OCqrh1pvmJmbNWc2Api/YXDm6lc+uupLyvowzOuADs99NAQYiSk1AsFvQPigI2d/F5OKno35gkMtBLDyFQzMwy2tfQlAmcK8iZvb+GF780XgjT4E7cXvOiMIHA5nYZbNFFbNSnjSfWeq6vKNiTsw5mHdYizu2bZkaSjg2sVdoa1jyFHusoAaOTCL+PG5/oLZ+d5743KQPFld8JIoYKn7LiQXZ3GOZ6HOFQkcan22p3MOOhhJFUGEqYC4zy0Juwlo/wzffakvhv7lhmcZE5PA+KfecYkPwPY7RIjPSj7p7Y//FwJI2ZC6PjDjZy4J14r5PrGITwD+JM//Jvj4RiHDEdmDen+2RTCD0UsCqeCJSOHC6JSpAIm0GFUhkpgpR9j6B/gc+v6DjVAN0V9pVkAqQf9DExGj0wiTULKjAjFl1Bw6Zq0yNYvnNbLADM4UlCHYaZ3g5duo1RpVCNOmRgwj5q0QLELNKuwC81oQ3S4HqGbfeaTEO6NBUrtPWHqs3xCgYNOiYSRIZzZO+DdEVlf6jT4aTw8Qpox0GD5Q2milAUU5M45Abc1sahtrCo1+NKZcIDR6/nNE06pQtA3MsNwqxDQ7ATQq6A5TMr8tobpH8xFUSP1Cd7SNpG8evsfU8XaOlBRuyQallsuxMhwwZ3txexni98XhcaXj/K/RuwQ8mSEh7yAco4nl+zAJbjDbUMjI5VYVkTgoRvrKcr+yc0MJj399ZFw+eP7YppnYx2LgJpjhBMICctef1bHoNwsh5gxnG9h573MLsaP7VsoEwErI2icHTvd1LZScuA8BCL08HN3rv9ARcdl5s5Or2byPwpUscuK12kRx0BUE7a/BI+YAaE/N0KUAiuchMUWFkh2C54mvVRMSdjk+s05kRgQGzSdO7n8sGV6SV8UvpWD/3YV+KWFlu1uQFZ8FISJCcYPk2dqlk+DjDsoey0RkHq3q8jza+uY617KHfctmr+U7zW+DbM7TBULA1Zn1cHN4t1xG7rrTlPjC1okIL0gDeCk8TJpfCNOTr9eRkqArAOL1wPpW85vA7mVkPM0AifcgZpq4m8IY6bGfmT7ajmnsF0STt5Hv6X6mM5Hufb8TPRTKE9ZUBdiW2hCDpxnhocarHVSJ41Bl37Z6muV8nAKtYHqqlVFNfoDHqZxUtDOTCbXmnzxOF6bbyc4gdPsgWhqxq6gaS0WFECk+4xtl8YSij6VV2uN1Ced8HuErp8/zPwUYACrO7BuLatvJAAAAAElFTkSuQmCC">
  </thumbnail>
  <script type="text/flathead">
  </script>
  <script type="text/ceci">
    Ceci(this, {
      init: function (params) {
        this.pieSize = 200;
        this.colors = {
          "blue" : "#2f8bd1",
          "green" : "#6fba00",
          "yellow" : "#e6d400",
          "orange" : "#ff7b00",
          "red" : "#eb1900",
          "pink" : "#ff4fa7",
          "purple" : "#a016d2"
        }
        this.myColor = ["DDD","DDD","DDD"];
        this.myData = [0,0,0];
      },
      updatePie : function(){
        var pS = this.pieSize;

        var myTotal = 0;
        for (var j = 0; j < this.myData.length; j++) {
          myTotal += (typeof this.myData[j] == 'number') ? this.myData[j] : 0;
        }

        var canvas;
        var ctx;
        var lastend = 0;

        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, pS, pS);
        ctx.textAlign = "center";

        for (var i = 0; i < this.myData.length; i++) {
          ctx.fillStyle = this.colors[this.myColor[i]];
          ctx.beginPath();
          ctx.moveTo(pS/2,pS/2);
          ctx.arc(pS/2,pS/2,pS/2,lastend,lastend+(Math.PI*2*(this.myData[i]/myTotal)),false);
          ctx.lineTo(pS/2,pS/2);
          ctx.fill();

          var angle = lastend + (Math.PI*2*(this.myData[i]/myTotal)/2);
          var x = 100 + 50 * Math.cos(angle);
          var y = 100 + 50 * Math.sin(angle);
          var fontSize = 10 + (40 * this.myData[i]/myTotal);
          ctx.font = fontSize + "px sans-serif";

          if(this.myData[i] > 0){
            ctx.fillStyle = "rgba(255,255,255,.3)";
            ctx.fillText(this.myData[i], x , y+5);
          }

          lastend += Math.PI*2*(this.myData[i]/myTotal);
        }
      },
      updateData : function(listener,channel,option){
        if(parseInt(listener)){
          listener = parseInt(listener);
          this.myData[option] = listener;
          this.myColor[option] = channel;
        } else {
          this.myData[option] = this.myData[option] + 1;
          this.myColor[option] = channel;
        }
        this.updatePie();

      },
      defaultListener: 'setFirstValue',
      listeners: {
        setFirstValue: function (listener,channel) {
          this.updateData(listener,channel,0);
        },
        setSecondValue: function (listener,channel) {
          this.updateData(listener,channel,1);
        },
        setThirdValue: function (listener,channel) {
          this.updateData(listener,channel,2);
        },
        resetValues: function (value, channel) {
          this.myData = [0,0,0];
          this.updatePie();
        }
      },
      endpoint: true
    });
  </script>
</element>
