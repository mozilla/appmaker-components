<element name="app-shutter">
  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-shutter.css">
    <div class="start"></div>
    <div class="modal hidden">
      <div class="livefeed"></div>
      <div class="buttonbar hidden">
        <button class="looksgood">Use this</button> 
        <button class="startover">Try again</button> 
        <button class="cancel">Cancel</button> 
      </div>
    </div>
    <button class="freeze hidden">freeze!</button>
    <img class="snapshot">
  </template>
  <description>
    When clicked takes a picture, and broadcasts image
  </description>
  <thumbnail>

<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAeCAYAAABNChwpAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpBQjQ0QTNERjdCRkFFMjExOTI3Q0ZCMTdDMTBCM0U2NSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozRDNGMUQzMjE3MTgxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozRDNGMUQzMTE3MTgxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQ2QzRDQUJGQjdGQ0UyMTFCOTkwRkVEOUIzNUFDOTc4IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkFCNDRBM0RGN0JGQUUyMTE5MjdDRkIxN0MxMEIzRTY1Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+xqJedwAAAgZJREFUeNrUls8rRFEUx58xSLJVsrNiCElNQiSJTLG1JhTF7FjxF/itjEyysVSEKNmwwBQjv7JRFn6ULWH8/J76Tk2Tmffum4uc+nR7951zz/e9e895z7m4tGqYWBbYACWGmgVBPbiP5+SwsNC8jeQGY+bMnMwEVIMG8AJaQDJIMkF8mhnTBGoSETDEcQAsgQ8LTy4+y6Cf14NmAhrBDfj8BlEfAOM2tmCCsTUx1pacjSLAD7LjLNQB3m0IeGdsLJOcfkdE8qoYexo07FswxppVYRGRZ2DH+D3bUSnDaHOBYXAOnskZ51yqi6kISAWT4Bh4QR5II/mck3vTIF23AEkuLbMbvLEqykEmKeec3OsEK4zRJmAE1IFr4Aa9YBc8kF3OuelTyy3RIqCATxUCHpOqCLL7SRfsYmzCAtrZXn0WS/IIzDCmXYeABo4LCgd2ISo2IQG5HA8UBBxGxWopQxVL4RjSIeCSY6mCgEKOVzoErHNsVRAQ9t3UIcDPL5uUYrEF/yL6SsysDgEnLME0dsN4v2cicI2+PsZqOYRevs4csAdGQRnIIGWc26fPFmO0teIQO9wUcLLtBiJacYBzTj65x0oFqJahLNjDPR4DF+AVPIJTzhWzBT9ZXdRpo8YlWZ+uhvFTjeh/Cqj8xbwVkWfgln/G23/wAu4c/Gbf/UFy+XNq+xJgABl4dqJGhJx9AAAAAElFTkSuQmCC">

  </thumbnail>
  <script type="text/ceci">
    Ceci(this, {
      startVideo: function() {
        try {
          var that = this;
          window.navigator.mozGetUserMedia({video:true}, function(stream) {
            that.livefeed.appendChild(that.video);
            that.video.mozSrcObject = stream;
            that.video.play();
            that.modal.classList.remove('hidden');
            that.livefeed.classList.remove('hidden');
            that.freeze.classList.remove('hidden');
            that.buttonbar.classList.add('hidden');
            that.start.classList.add('hidden');
            that.snapshot.src = '';
          }, function(err) {
            console.log(err);
            that.stopMedia();
          });
        } catch(e) {
          console.log(e);
          that.stopMedia();
        }
      },

      stopMedia: function() {
        this.video.mozSrcObject.stop();
        this.video.mozSrcObject = null;
        this.livefeed.removeChild(this.video);
      },

      hideControls: function() {
        this.stopMedia();
        this.modal.classList.add('hidden');
        this.start.classList.remove("hidden");
        this.buttonbar.classList.add("hidden");
        this.snapshot.classList.add("hidden");
      },

      looksGood: function() {
        this.hideControls();
        console.log("emitting", this.snapshot.src);
        this.emit(this.snapshot.src);
      },

      captureImage: function() {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');

        canvas.width  = this.video.videoWidth/2;
        canvas.height = this.video.videoHeight/2;
        ctx.drawImage(this.video, 0, 0, canvas.width, canvas.height);
        var dataurl = canvas.toDataURL('image/png');
        this.setValue(dataurl);
        this.buttonbar.classList.remove("hidden");
        this.freeze.classList.add("hidden");
        this.snapshot.classList.remove("hidden");
        this.livefeed.classList.add('hidden');
      },
      init: function (params) {
        var video_status = false;
        var video = document.createElement("video");
        this.video = video;
        video.setAttribute("width", "100%");
        video.setAttribute("height", "100%");
        this.livefeed = this.querySelector(".livefeed");
        this.snapshot = this.querySelector(".snapshot");
        this.modal = this.querySelector(".modal");
        this.start = this.querySelector(".start");
        this.buttonbar = this.querySelector(".buttonbar");
        this.looksgood = this.querySelector(".looksgood");
        this.startover = this.querySelector(".startover");
        this.cancel = this.querySelector(".cancel");
        this.freeze = this.querySelector('.freeze');

        var that = this;
        this.start.onclick = function (e) {
          that.startVideo();
        }
        this.freeze.onclick = function (e) {
          that.captureImage();
        };
        this.startover.onclick = function (e) {
          that.startVideo();
        };
        this.cancel.onclick = function (e) {
          that.hideControls();
        };
        this.looksgood.onclick = function(e) {
          that.looksGood();
        }
      },      
      listeners: {
        setValue: function (val) {
          this.snapshot.src = val.toString();
        }
      },
      broadcast: function(e) {
        this.emit(e)
      }
    });
  </script>
</element>
