<element name="app-shutter">
  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-shutter.css">
    <div class="start"></div>
    <div class="modal hidden">
      <div class="livefeed"></div>
      <div class="buttonbar hidden">
        <button class="looksgood">Use this</button> 
        <button class="startover">Try again</button> 
        <button class="cancel">Cancel</button> 
      </div>
    </div>
    <button class="freeze hidden">freeze!</button>
    <img class="snapshot">
  </template>
  <description>
    When clicked takes a picture, and broadcasts image
  </description>
  <thumbnail>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAeCAYAAABNChwpAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEQjQxQzY0MzE4M0YxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEQjQxQzY0NDE4M0YxMUUzQkQ3OEUxRDEyODNBNUUxMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkRCNDFDNjQxMTgzRjExRTNCRDc4RTFEMTI4M0E1RTExIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkRCNDFDNjQyMTgzRjExRTNCRDc4RTFEMTI4M0E1RTExIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+FE4HFwAAAy9JREFUeNrMVmtIFFEU/mZ2J03TzSxfG+puaKZlBBURGPTDfCSSKNlTMiMCf4TQrxCKYqMfQQ8oENICJRMjg8oXgZCUEUE+MB+Ir9Q1RTNt03Z1pntnd6Wt3Z1Zd7U+uMzrnHu+e+653xkIggBng581BAs83yy4CrPPBqn5IYNAg7BE8CZjrdT8jMjCDnpT1EzI1bJsn537y4V5kzB27RxveFdPvHiGfLYOCsEyzGBY1ndPohB0sYhhlBzDG2YSWV+/V3AAFo7hy6m1OnozWaKDoalWQYIryaPC4mclwVremQchaGiqYyeLdVZ+18liFI6C0AykkGsxGaH2DH52N2O4IB3gF6wr/X3l1nvm76UpoL71gveKine0SD0ZeZTAiKPgFEP5B2DsbcdSsEobh413652Z6CkBcf9GLmRgrv09VgLecbsRdqPKtgZWKvifsZQupzU8GmuSj4GcDnAh4eI7k34APz40YKauHKbBbpfmW9wCUqnODZUcAs9ehn9aDj1q9o0EHtM1jzBRdAmCcc7pfNqaYfkZoMGDr5TCZ0cCiCZgqOo+emoqMdXzSfyu2hSLyOQsaDJPwz/1BDi1BqOFx0Vbj2QgMF8HVdopGMf1eFuQjfHOVrt2QVvisfdmBbj1oZh6/gCT9wolM8BKMeQiNkOVehKCyYjX5w87DE4x1tGKRmJDJBiqgzmirxQkCfglHRVFZeDZQ3ztbpOccKKrDYPEliE+oq+7BGi1U/STPZeLwdpKG1+3CHChEeaVdbTIJjDe0broK7hLYClglebDRevG7QwYichQBMRsl02AHktRoMaG7HQpFwlQhaMIT8qUTUCTkiVeZz82up+B7/WPicAtQJuZi7XRWyUnDCQ2kRm5tH2L0uw2AVN/J6arS8FyXki4XYmA6G0ObakQ7bvzBAy3Ct+qy0RfjyihjRSTwup7WoK+lxWY7usy14cmBlHpRxB2KFe0nW15IynFViV0qRmtI81I5eFmJJvAYjsm8upH2vFqSzumq5z/8lksOLrnRhlpd4uApyC7GS03/h8C9EdxpeAdu8vmGDr9LV9mjNIMnKE3/yA4rcK8XwIMAJBZIBsjrusRAAAAAElFTkSuQmCC">
  </thumbnail>
  <script type="text/ceci">
    Ceci(this, {
      startVideo: function() {
        try {
          var that = this;
          window.navigator.mozGetUserMedia({video:true}, function(stream) {
            that.livefeed.appendChild(that.video);
            that.video.mozSrcObject = stream;
            that.video.play();
            that.modal.classList.remove('hidden');
            that.livefeed.classList.remove('hidden');
            that.freeze.classList.remove('hidden');
            that.buttonbar.classList.add('hidden');
            that.start.classList.add('hidden');
            that.snapshot.src = '';
          }, function(err) {
            console.log(err);
            that.stopMedia();
          });
        } catch(e) {
          console.log(e);
          that.stopMedia();
        }
      },

      stopMedia: function() {
        this.video.mozSrcObject.stop();
        this.video.mozSrcObject = null;
        this.livefeed.removeChild(this.video);
      },

      hideControls: function() {
        this.stopMedia();
        this.modal.classList.add('hidden');
        this.start.classList.remove("hidden");
        this.buttonbar.classList.add("hidden");
        this.snapshot.classList.add("hidden");
      },

      looksGood: function() {
        this.hideControls();
        console.log("emitting", this.snapshot.src);
        this.emit('pictureTaken', this.snapshot.src);
      },

      captureImage: function() {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');

        canvas.width  = this.video.videoWidth/2;
        canvas.height = this.video.videoHeight/2;
        ctx.drawImage(this.video, 0, 0, canvas.width, canvas.height);
        var dataurl = canvas.toDataURL('image/png');
        this.setValue(dataurl);
        this.buttonbar.classList.remove("hidden");
        this.freeze.classList.add("hidden");
        this.snapshot.classList.remove("hidden");
        this.livefeed.classList.add('hidden');
      },
      init: function (params) {
        var video_status = false;
        var video = document.createElement("video");
        this.video = video;
        video.setAttribute("width", "100%");
        video.setAttribute("height", "100%");
        this.livefeed = this.querySelector(".livefeed");
        this.snapshot = this.querySelector(".snapshot");
        this.modal = this.querySelector(".modal");
        this.start = this.querySelector(".start");
        this.buttonbar = this.querySelector(".buttonbar");
        this.looksgood = this.querySelector(".looksgood");
        this.startover = this.querySelector(".startover");
        this.cancel = this.querySelector(".cancel");
        this.freeze = this.querySelector('.freeze');

        var that = this;
        this.start.onclick = function (e) {
          that.startVideo();
        }
        this.freeze.onclick = function (e) {
          that.captureImage();
        };
        this.startover.onclick = function (e) {
          that.startVideo();
        };
        this.cancel.onclick = function (e) {
          that.hideControls();
        };
        this.looksgood.onclick = function(e) {
          that.looksGood();
        }
      },
      listeners: {
        setValue: function (val) {
          this.snapshot.src = val.toString();
        }
      },
      broadcasts: ['pictureTaken']
    });
  </script>
</element>
