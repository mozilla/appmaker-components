<element name="app-timer">
  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-timer.css">
    <div class="timer">
      <div class="current-time"></div>
    </div>
  </template>
  <description>
    Listens for a message and counts
  </description>
  <thumbnail>  
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozMzA4QTM0NjE4MDQxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozMzA4QTM0NzE4MDQxMUUzQkQ3OEUxRDEyODNBNUUxMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjMzMDhBMzQ0MTgwNDExRTNCRDc4RTFEMTI4M0E1RTExIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjMzMDhBMzQ1MTgwNDExRTNCRDc4RTFEMTI4M0E1RTExIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+YhZbzwAABKdJREFUeNrEV31sU1UUv/e+z7Z2K6hrtyH7ICwOh/g1BImBbM6MaPQfZWYjTs2UmBhM/IcQZSBZUP8xi4lRgsNhZCNGCH9MSVjGgkqcbho/QNxUtqnrvqCr69d7bd97nvv6Wkqzrq8zqyc56fvoO+d3zj3n3N/FmqYhk0KQqjyqylItZpgtmOVKEWHyjHdzoL+DXgD9CrQHVDVllQLIoBWaEj2mZSkA9GMl6Ls9k32cIQPvg+4ykCLp8neR4MBZIl36lkQmx5Dq89KPNWJ3YK6oLGrZ8EDAurmeCGuq8hHGsc/C8tHRx8tbys9MLOgoHQAX6Ieg9RSmv/+UNHf8bSHiHiNmksoVlSLHUy+r9oeeYBAmAELqx7zYCO+mzACoAD0NWql4r/qnDjTz8vAPPDIv1KAevlBxF3K+elhlC1YRLRoZgWAewxw/vBiAEtA+0DXybz95p15rylPmPSQLxyjuPC5M3krNuf+oIq6rZqGIx6Fwt8HjsXQAqPMa6eI3/sm9DTZAjVF2EgFlU0FAx2iFh7pD4vrNVijo85hht11vretymDqPXp30T7U+bTXjHApL1yRhkzKRyAq1NbW/mYnOugPgfCvcd6QCoOv+AtJUbbqthVdDfoKWJjglqEQQaijATx/apVEfkJHnoIPWJQBAq7TSX1/fyWiWBZcVOPnX723+c6ck/cZi26sDuPbePgHzQhPtc293O4eWV/BcdzuhviALO2mNEnt9YwN9I10cQNDnaLklMjHKyyM/+mProjxCYGJtp9fBwXMoR4IDFz63GktfQ4gtb6OegV+GcgUARvqQXntqWK4l5KZ8l54a92jOAEQmrsRakBfKCBFEUUfj8+YMQNwXFL+FoP9ZWFUKhonVLsKWipS52SUZSZmGCbmyvXhhZgO+jAkZIJCOaXoD+3nOouaKy2NLEfD9zSr+fwZZ520lYuW9CIhGVobSRZhJqC9jPA8STQr20hvrxtqcZcBaXRNbAjnUR64dOXhCR1W1CVEmswxyw35PfYhV9+vXnmNvfUqK23vmozMTn1EO59jxUiZjSqpBs+woLo6G3YpB07pcBzqDehtijttDf+11O5CwdoOZLddUtKn/Bduyve7JmE9ePJjYjpkVBZdgPTqBLqGCPe8qxGJL54BZxHnUyNDCrWexhZ2tHWGIHsMm9AE8Gr6BEWHB8izQpS+44jLGua9Dhu0y23XWUshIMiVTXG3H/ewthXZwfh4CfX4hSoaALjXDXj1uuftBwfX6R+FFMpGYqsn1ZdjTUiJXXW1dEpDSldQ2OH8mMy3X1F5I1WrgB5GZN19kgSHjpZS/sPZOuqQqDB6oOvVPsFkHj0fMHExKIVW0JrbCh8jX+wnynngHRSbHzU26whI4mOzWi1qveDn0NSxxYzIdzwTAmNXRI5hlW2I3qj4pAwO9SL48pIOJ72p0tlOnQuV9mm3Tw0i8oxpTx3rfznu6xhvW70x3NMt4OA27x6ois+6ebA+nUc/M6dDPA/f8UV+E/8vhND7zeSb/5tUrml5pYQtLtnCrystYx60ObHAJTVF8miz9BXR+EGhWv6fzjZOBL3uktFEnyb8CDACRd7mB9eQFuAAAAABJRU5ErkJggg==">
  </thumbnail>
  <script type="text/flathead">
  </script>
  <script type="text/ceci">
    Ceci(this, {
      init: function (params) {
        var that = this;
        this.hasAlert = false;
        this.alertTime;
        this.mS = 0;
        this.mode = "up";
        this.updateDisplay();
        this.timerInterval = false;
      },
      updateTime : function(){
        //Get time difference between ticks
        this.elapsedTime = new Date().getTime() - this.startTime;
        this.startTime = new Date().getTime();
        //Add it up in milliseonds

        if(this.mode == "up"){
          this.mS = this.mS + this.elapsedTime;
        } else {
          this.mS = this.mS - this.elapsedTime;
        }

        this.updateDisplay();

        if(this.mode == "down"){
           this.checkAlert();
        }
      },
      checkAlert : function(){
        // var sec = Math.round(this.mS/1000 * 10)/10;
        if(this.mS <= 0) {
          this.mS = 0;
          this.mode == "up";
          this.broadcast('ding');
          this.stopTheTimer();
          this.updateDisplay();
        }
      },
      updateDisplay : function(){
        var hour  = Math.round((this.mS/1000/60/60)) % 60;
        var min   = Math.round((this.mS/1000/60)) % 60;
        var sec   = (this.mS/1000) % 60;
        sec = Math.round(sec * 10)/10;
        if(Math.round(sec) == sec) { sec += '.0'; };
        if(min < 10) { min = "0" + min;}
        if(sec < 10) { sec="0" + sec;}
        if(hour > 0) { hour = hour + ":"; } else {  hour = "";}
        this.currentTime = hour + min + ":" + sec;
        this.querySelector('.current-time').innerHTML = this.currentTime;
      },
      startTheTimer : function(){
        this.startTime = new Date().getTime();
        var that = this;
        if(!this.timerInterval){
          console.log("setting timer interval");
          this.timerInterval = setInterval(function(){
            that.updateTime();
          },50);
        }
      },
      stopTheTimer : function(){
        clearInterval(this.timerInterval);
        this.timerInterval = false;
      },
      resetTheTimer : function(){
        this.mS = 0;
        this.mode = "up";
        this.updateDisplay();
      },
      broadcastCurrentTime : function() {
        this.broadcast('currentTime', this.currentTime);
      },
      defaultListener : "start",
      broadcasts: ['ding'],
      listeners: {
        setTimer : function(listener, channel){
          this.mode = "down";
          this.mS = 1000 * parseInt(listener) || 10000;
          this.startTheTimer();
        },
        broadcastTime: function (listener,channel) {
          this.broadcastCurrentTime();
        },
        stop: function (listener,channel) {
          this.stopTheTimer();
        },
        start: function (listener,channel) {
          this.startTheTimer();
        },
        reset: function (value, channel) {
          this.resetTheTimer();
        }
      }
    });
  </script>
</element>
