<element name="app-timer">
  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-timer.css">
    <div class="timer">
      <div class="current-time"></div>
    </div>
  </template>
  <description>
    Listens for a message and counts
  </description>
  <thumbnail>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpBQjQ0QTNERjdCRkFFMjExOTI3Q0ZCMTdDMTBCM0U2NSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxMEUxMDhDRTE3NTQxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5OTRCQjlFQTE3NTIxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQ2QzRDQUJGQjdGQ0UyMTFCOTkwRkVEOUIzNUFDOTc4IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkFCNDRBM0RGN0JGQUUyMTE5MjdDRkIxN0MxMEIzRTY1Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+uf0OyAAAAr5JREFUeNrEl89rU0EQx1+2QS9eClJ680dr1LN6aLUBKxKtP0CpeBJrBfUfUFP/AFsQPLcFtUUvFtT6q6AglVbtIWcPrYn2aEHwoCchjd+R75bJo5tsX16eAx8eL9mdmZ2dNzubevr8deApBpwAPeAg6ASt/O8nKIKP4AN4BVZ9lKY9xmTAEBioMaaNdIPr/G0CDIOlequqJaNgkcYrYA7cBIdAO9hM2vnbDY6pcM4idWw4AqLwATjGUP5bzZnTfUXH+BUiW3Dn2YuZThW1q2AbuAS+hyem1skBCfk02Au+gfMwXAgiCBw5gMdjsAN8BmfDWxJ2QDx9BzrAe3AOxn84lFe9Y5zLia14PAFZ8BUcAcuuHLhP429BzmVcSYU4hTqOgjdgJ7jnSsIx0MvE6cfEP0FMQl391N1LW1UOyL5fAWVwARN+BTELdP4W3bQhtnZrB4b4nIyacJ5OFPhFieStAy3qOx8Omi8jqk60iAM2fedqfOdxRqHIYiXSZ1jbRWaC5MTa6jGs3yKfEnRggc8uKcW7+PKlEY2+hYliq2EmHTpSo0q4GKXqjLe2Wk3wn8VobyLMTzmoJ2tRT3Pv25gLKxv4nBpZeMbmglHZ35Vg5K2tBcMeLmC/l5TY8M2LA7YhyLKTaarQxlrxMzydJpg8+QRWn2fyi82yUQeEyAA83N/E1e9T3fWIPo6lURjnyfgQA7c0wbjofEQb47RZ1RFJ9zoL9oApTNgUo3HRNUXds7S1bk84yIbxuHTGcUSCOqapc5k2nBcTGZBTThS4b43seUEZz+mO2HUvENnODvmwupjcRvUreRqWzvoWE84w7INh47Uc0Fczu1+rLFovWT1LoXOkg73FKV7TjOq2r0W9nMrEu1zNRV4usp47MClRq3c59bkdLzGUl8FJVrFurlj3EiVGZp7X87KPl38FGAAwhM+8Tn4XUQAAAABJRU5ErkJggg==">
  </thumbnail>
  <script type="text/flathead">
  </script>
  <script type="text/ceci">
    Ceci(this, {
      init: function (params) {
        var that = this;
        this.hasAlert = false;
        this.alertTime;
        this.mS = 0;
        this.mode = "up";
        this.updateDisplay();
        this.timerInterval = false;
      },
      updateTime : function(){
        //Get time difference between ticks
        this.elapsedTime = new Date().getTime() - this.startTime;
        this.startTime = new Date().getTime();
        //Add it up in milliseonds

        if(this.mode == "up"){
          this.mS = this.mS + this.elapsedTime;
        } else {
          this.mS = this.mS - this.elapsedTime;
        }

        this.updateDisplay();

        if(this.mode == "down"){
           this.checkAlert();
        }
      },
      checkAlert : function(){
        // var sec = Math.round(this.mS/1000 * 10)/10;
        if(this.mS <= 0) {
          this.mS = 0;
          this.mode == "up";
          this.emit("Ding");
          this.stopTheTimer(); 
          this.updateDisplay();
        }
      },
      updateDisplay : function(){
        var hour  = Math.round((this.mS/1000/60/60)) % 60;
        var min   = Math.round((this.mS/1000/60)) % 60;
        var sec   = (this.mS/1000) % 60;
        sec = Math.round(sec * 10)/10;
        if(Math.round(sec) == sec) { sec += '.0'; };
        if(min < 10) { min = "0" + min;}
        if(sec < 10) { sec="0" + sec;}
        if(hour > 0) { hour = hour + ":"; } else {  hour = "";}
        this.currentTime = hour + min + ":" + sec;
        this.querySelector('.current-time').innerHTML = this.currentTime;
      },
      startTheTimer : function(){
        this.startTime = new Date().getTime();
        var that = this;
        if(!this.timerInterval){
          console.log("setting timer interval");
          this.timerInterval = setInterval(function(){
            that.updateTime();
          },50);
        }
      },
      stopTheTimer : function(){
        clearInterval(this.timerInterval);
        this.timerInterval = false;
      },
      resetTheTimer : function(){
        this.mS = 0;
        this.mode = "up";
        this.updateDisplay();
      },
    defaultListener : "start",
      listeners: {
        setTimer : function(listener, channel){
          this.mode = "down";
          this.mS = 1000 * parseInt(listener) || 10000;
          this.startTheTimer();
        },   
        stop: function (listener,channel) {
          this.stopTheTimer();
        },
        start: function (listener,channel) {
          this.startTheTimer();
        },
        reset: function (value, channel) {
          this.resetTheTimer();
        }
      }
    });
  </script>
</element>
