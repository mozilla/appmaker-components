<element name="app-map">

  <template>
    <link rel="stylesheet" href="{{ASSET_HOST}}/assets/style/app-map.css">
    <div>
      <div class="map"></div>
      <button class="pin">pin this location</button>
    </div>
  </template>
  <description>Displays a map centered on where the phone is, and optionally emits locations the user identifies.</description>
  <thumbnail>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAgCAYAAAAIXrg4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpFRTNENTJBNzE3RkIxMUUzQkQ3OEUxRDEyODNBNUUxMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpFRTNENTJBODE3RkIxMUUzQkQ3OEUxRDEyODNBNUUxMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkVFM0Q1MkE1MTdGQjExRTNCRDc4RTFEMTI4M0E1RTExIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkVFM0Q1MkE2MTdGQjExRTNCRDc4RTFEMTI4M0E1RTExIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+VjUtPgAABXdJREFUeNqkVntsU1UYP+fedn2stGsH7MlKmZONEEcAJQFkyIJhjjBE/hjCUMAsIwoucQQJiEbFyDsYcZNIUGQdwehkgsTAXBwahRCcCxDZpB0bc2OOdVvXx+7r+J27dra3XZl6ktN+955zfr/vfq/zYUIIGmsIPZ3TGIOxBKviFmOVajrCTCJCRCCi2IUQbgO5AavUdkdBmjP03LQLnaMyjkYgeQanIoY5zGjjVyCMGRR7SIhIZ4B8OxC1K4kiCSSxCECr4UA8EQXkvXKReH66gP03ryLxQTfCag1iJyYjzaOzJMPCQkH/RL4aMSxGhHiAqNRRmGEPhQsnIFI5AB8EifFerScPjr2J+U5nTPXVaTZx4pa9Hl3uAiNFIJx/u7Moc38kgSQWgyZ22IJd9sO8q/qQGsXwT9jAWDKXbPOZi7fGgwwkw+ucRdPsowTwworV6lugvd5Vc8TvOrlPOwZUKCNWrgGJYH6+HBSTvICVQ33CBDTYT8G9174XXJ/vV4IT/YJnBlIP1XltX9+RbGcdYsrhb4Z08572BwiDE7tOHVB7rzVwFAv8dyD4BVb4d4CJcMemJzHffTcUXJy4dZ/TWLD2kWif0193orOvclc8iKbgF6mSM6SM4z9iMDc1VSZDBH4tdarnykVJAY7in1rVQsElgSdNh3bwZ5fYpLNLppKmg69L9F3Cig1puryVPbCVD5pP6G6nWALFBFOtgx+STxc8l88p492XsKZcT4XmD3aTVnulmht0MdxgP26tqWJuVu6RNTYVbUyjiof6xHP5fND0+Qxm2RlUHv7jhtKZw+rkKSn04e650xHJ5qj9TP7X2nJ0SocP374+sp9V5TDgEIts7L77yphkaciOM5rC9gm9XSMLDGsZ1YzwnBIsjmtvHaCCdXmxpADGtpXrZdnf8huJJMejqAwUrhY5I9MzkUIrdf8XRz304bGtb+OsNWVSnDEB0ZlVXEZmbt4po/R/VaU0Hw5iEZ6/qyKcrxGrJszUz16EOMfNsI3exrqkvqzcQcvqMuOs197HMMOSrNd+BPmvXIqwn35OnpwXROAasL+labEmK7eBa/ud3NucH9Xm2nlLienZUqSbPkte991uIgO1H+No4HSkV9aTuKnZGOrSPHxnWarWerr5FmtKtHXtXIN81xvR/xk6sETKnhok+YZut62ank3tN8z/2UYrKLKUbCMQu/8dHc6a11WMlIDeLrmiMnApkJ69Lx+HS6ZVkz0bGxavFBVhOO5hyCtC2pw5SHL3O3o/3FEtE9CfjE9/8YtuVzmVE1/aLWKNjqb+eInkPXAGWTbulGX+fkeFr/ln/yiBHKbJ1m/JsK+WtUyOSyx9y03zJYSAPKxsW17cLqgmpWLR1fNd55ZldcFFZQy/AgWqHwqcWZc7fyCwTqLU/rBn7YzHialoE0sEwS26/ioLfH30S59WV+gUTsHGgfaN8wnxe41RFPmHCUyTXlUvggVYyet+oe257JOh6xEHAbwaatCXrHmSKWlH1QN4xcWwPT+54siQDO4bOq8ER2NqhnEZkHRDx5BpLFx/T25NIsE5c0nFjfiFhQYw6304tCEqVIzGKw9mPdhV7Hy1wMc5bplCCbQz5nakHqhNgZIJ9UxY6lxubVACRO+LwscumO+IfT1DHaWLNJLHzcpV2GASphz7gQMz0uvyDbjc340GjmI5LzDeA+0uQegaknaf4OCeRfSuTdr1iQxO1+iemMn9kC+ANtJtxhrtr+B8q/vimUFoKfkJ+asToUlwSn7vXHBs31jaj4tgpAm+NxuSqJG2kyMeIB5IyvlYq28G80QFjh1FiqGanH4dbrySQAKJEDVrKfi46h8h/6qubQ5k8UfjPfC3AAMA21+By9WDUnsAAAAASUVORK5CYII=">
  </thumbnail>
  <script type="text/ceci">

    function Location(value) {
      this.value = value;
      this.editor = 'app-map';
    };
    Location.prototype.toString = function() {
      return String(this.value);
    }


    var element = this;
    require(['http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js'], function(L) {
      Ceci(element, {
        init: function() {
          element = this;
          var locateAtStart = false;
          var lat = this.getAttribute('lat');
          var lng = this.getAttribute('lng');
          if (! this.hasAttribute('lat')) {
            lat = "51.2982709";
            lng = "-116.96357390000004";
            locateAtStart = true;
          }

          var map = L.map(
            element.querySelector('.map'), {
              center: new L.LatLng(lat,lng),
              zoom: 4
            }
          );

          L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {maxZoom: 18}).addTo(map);
          var t = element;
          t.map = map;

          map.on('locationfound', t.onLocationFound);
          map.on('locationerror', t.onLocationError);
          map.on('moveend', t.noteLocationChange);
          console.log("locateAtStart", locateAtStart);
          if (locateAtStart) {
            map.locate({setView: true, maxZoom: 16});
          } else {
            this.centerOn(lat, lng);
            this.setZoom(5);
          }

          element._pin = element.querySelector(".pin");
          element._pin.onclick = function(e) {
            element.broadcast('location', element.map.getCenter());
          }
          element._pin.onclick();
          if (! this.hasAttribute('pin')) {
            this.setAttribute("pin", "false");
          }
          this.controlPin(this.getAttribute('placeholdertext') == "true");
        },

        noteLocationChange: function(e) {
          var center = this.map.getCenter();
          this.currentCenter = center;
          element.setAttribute('lat', center.lat);
          element.setAttribute('lng', center.lng);
        },

        getCurrentValue: function() {
          return this.currentCenter.toString();
        },

        onLocationFound: function(e) {
          var radius = e.accuracy / 2;

          L.marker(e.latlng).addTo(this.map)
            .bindPopup("You are within " + radius + " meters from this point").openPopup();

          L.circle(e.latlng, radius).addTo(this.map);
        },

        onLocationError: function(e) {
          alert(e.message);
        },

        sendCenter: function (e) {
          this.emit(new Location(e));
        },

        controlPin: function(truefalse) {
          if (truefalse) {
            this._pin.classList.remove('hidden');
          } else {
            this._pin.classList.add('hidden');
          }
        },

        broadcast: function(e) {
          this.sendCenter(e);
        },

        editable: {
          "location": {
            title: "Location",
            type: "text",
            description: "Set where the map should be centered (empty means where the phone is)",
            postset: function(v) {
              this.findLocationByName(v);
            }
          },
          "pin": {
            title: "Show pinpoint button",
            type: "boolean",
            description: "Show the button that emits current location",
            postset: function(v) {
              element.controlPin(v);
            }
          }
        },
        centerOn: function(lat, lng, type) {
          var location = new L.LatLng(lat, lng);
          this.map.panTo(location);

          if (type == 'city' || type == 'administrative') {
            this.map.setZoom(11);
          } else {
            this.map.setZoom(13);
          }
        },
        defaultListener: "findLocationByName",
        broadcasts: ['location'],
        listeners: {
          recordLocation: function(val) {
            this.broadcast('location', this.map.getCenter());
          },
          centerOnLocation: function(location) {
            this.map.panTo({'lat':Number(location.lat), 'lon':Number(location.lon)});
          },
          centerOnPhone: function(val) {
            this.map.locate({setView: true, maxZoom: 16});
            this.map.setZoom(10);
          },
          findLocationByName: function(val) {
            if (!val) {
              this.centerOnPhone();
            } else {
              $.getJSON('http://nominatim.openstreetmap.org/search?format=json&limit=5&q=' + val,
                function(v){
                  element.centerOn(v[0].lat, v[0].lon, v[0].osm_type)
                });
            }
          }
        }
      });
      callback();
    });
  </script>
</element>
